version: '3.8'

services:
  # F5-TTS 服务（Mac M4 CPU 优化版）
  f5-tts:
    build:
      context: ..
      dockerfile: docker/Dockerfile.cpu
    container_name: f5-tts-service-cpu
    # runtime: nvidia  # Mac M4 不支持 NVIDIA
    environment:
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7860
      # 管理员认证配置
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - ENABLE_AUTH=${ENABLE_AUTH:-true}
      # Mac M4 CPU 优化
      - USE_CPU=${USE_CPU:-true}
      - USE_FP16=${USE_FP16:-true}
      - HF_ENDPOINT=${HF_ENDPOINT:-https://hf-mirror.com}
      - OMP_NUM_THREADS=8
      - MKL_NUM_THREADS=8
    volumes:
      - f5-tts-cache:/root/.cache/huggingface/hub
      - ../outputs:/workspace/F5-TTS/outputs
      - ../data:/workspace/F5-TTS/data
      - ${MODEL_CACHE_PATH:-/tmp/models}:/workspace/external_models
    ports:
      - "${F5TTS_PORT:-7861}:7860"
    restart: unless-stopped
    command: f5-tts_infer-gradio --port 7860 --host 0.0.0.0 --api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860"]
      interval: 45s
      timeout: 15s
      retries: 5
      start_period: 180s
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 16G
        reservations:
          memory: 8G

  # Nginx 反向代理 + 认证
  nginx-auth:
    image: nginx:alpine
    container_name: f5-tts-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    ports:
      - "${NGINX_PORT:-8080}:80"
    depends_on:
      f5-tts:
        condition: service_healthy
    restart: unless-stopped

  # Cloudflare Tunnel (本地测试暂时禁用)
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: f5-tts-tunnel
  #   command: tunnel --no-autoupdate run
  #   environment:
  #     - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
  #   volumes:
  #     - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
  #   depends_on:
  #     - nginx-auth
  #   restart: unless-stopped
  #   profiles:
  #     - production  # 仅在生产环境启用

volumes:
  f5-tts-cache:
    driver: local

networks:
  default:
    name: f5-tts-network