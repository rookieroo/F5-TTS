version: '3.8'

services:
  # F5-TTS 服务
  f5-tts:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: f5-tts-service
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7860
      # 管理员认证配置
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - ENABLE_AUTH=${ENABLE_AUTH:-true}
    volumes:
      - f5-tts-cache:/root/.cache/huggingface/hub
      - ../outputs:/workspace/F5-TTS/outputs
      - ../data:/workspace/F5-TTS/data
    ports:
      - "7860:7860"
    restart: unless-stopped
    command: f5-tts_infer-gradio --port 7860 --host 0.0.0.0 --api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Nginx 反向代理 + 认证
  nginx-auth:
    image: nginx:alpine
    container_name: f5-tts-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
      - ./nginx/auth.lua:/etc/nginx/auth.lua:ro
    ports:
      - "8080:80"
    depends_on:
      f5-tts:
        condition: service_healthy
    restart: unless-stopped

  # Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: f5-tts-tunnel
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
    depends_on:
      - nginx-auth
    restart: unless-stopped

volumes:
  f5-tts-cache:
    driver: local

networks:
  default:
    name: f5-tts-network
